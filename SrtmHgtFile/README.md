# 加载和解析 SRTM

### 代码概述


这是一个用于处理SRTM（Shuttle Radar Topography Mission）地形高程数据文件的C++类库, 其核心功能是**加载和解析 SRTM (Shuttle Radar Topography Mission, 航天飞机雷达地形测绘使命) 的地形高程数据文件**。SRTM 数据是全球范围内的数字高程模型 (DEM)，而 `.hgt` 是其数据文件的标准格式。

该代码能够处理两种不同分辨率的 SRTM 数据：

- **SRTM1**: 1 角秒分辨率 (约 30 米), 对应 DTED Level 2。
- **SRTM3**: 3 角秒分辨率 (约 90 米), 对应 DTED Level 1。

代码通过读取 `.hgt` 二进制文件, 将高程数据加载到内存中的一个二维数组里, 以便在应用程序 (例如飞行模拟器、地理信息系统 GIS) 中使用。


### 主要功能

1. **文件识别与验证**:
   - 通过文件名 (`NxxWxxx.hgt` 的格式) 来确定数据瓦片西南角的纬度和经度。
   - 通过文件的具体字节大小来自动判断是 SRTM1 数据 (25,934,402 字节) 还是 SRTM3 数据 (2,884,802 字节)。
   - 如果文件大小不匹配或文件名格式不正确, 则加载失败。
2. **数据加载**:
   - 以二进制模式读取整个 `.hgt` 文件。文件中只包含纯粹的高程数据, 没有任何文件头或元数据。
   - 数据以 "大端" (Big-Endian) 字节序存储, 代码会正确处理这种格式。
3. **数据解析**:
   - 将文件中的高程数据点 (每个点由 2 个字节表示) 读入内存。
   - 高程数据是 16 位有符号整数, 表示以米为单位的海拔高度。
   - 代码能正确处理 SRTM 中的特殊值: `-32768` 被视为空洞 (void) 或无效数据点。
4. **内存存储**:
   - 将解析出的高程数据存储在类内部的一个二维动态数组 (`short** columns`) 中, 以便程序后续访问和查询。
   - 同时, 代码还会存储该数据瓦片的元信息, 如西南角和东北角的经纬度、数据点个数、经纬度间隔等。


### 输入与输出


- **输入**:
  - **文件路径和名称**: 通过 `setPathname()` 和 `setFilename()` 方法设置。
  - **SRTM .hgt 文件**: 一个遵循特定命名规范和文件大小的二进制文件。
    - **命名规范**: 文件名格式为 `[N/S]lat[E/W]lon.hgt`。例如, `N40W118.hgt` 表示其西南角的坐标为北纬 40 度, 西经 118 度。具体为：
    - 格式：`N00W000.hgt` 或 `S00E000.hgt`
    - N/S：表示北纬/南纬
    - 00：纬度值（西南角）
    - W/E：表示西经/东经  
    - 000：经度值（西南角）
    - 扩展名：.hgt 或 .HGT
  - **文件内容**: 纯粹的 16 位有符号整数序列, 以大端字节序存储, 按行主序排列。
- **输出**:
  - 该模块不直接生成输出文件。它的输出是其内部状态的改变。
  - 成功调用 `loadData()` 方法后, `SrtmHgtFile` 对象内部会填充好高程数据。主要输出成果包括:
    - `short** columns`: 一个存储了所有高程点的二维数组。
    - `nptlat`, `nptlong`: 纬度和经度方向上的数据点数量 (SRTM1 为 3601x3601, SRTM3 为 1201x1201)。
    - `latSpacing`, `lonSpacing`: 经纬度方向上的数据点间隔 (1 或 3 角秒)。
    - 经纬度范围: 西南角和东北角的经纬度。
    - `minElevation`, `maxElevation`: 该数据瓦片中的最低和最高海拔。

### 模块解析

代码的核心是 `SrtmHgtFile` 类, 其主要方法如下:

| 类 / 方法                             | 功能描述                                                     |
| ------------------------------------- | ------------------------------------------------------------ |
| **`SrtmHgtFile` 类**                  | 继承自 `DataFile` 类, 是处理 SRTM `.hgt` 文件的主要实体。    |
| `bool loadData()`                     | **核心入口方法**。负责打开文件, 调用其他私有方法来验证文件、解析元信息并读取高程数据。如果所有步骤都成功, 返回 `true`。 |
| `bool determineSrtmInfo(...)`         | **元信息解析方法**。根据输入的文件大小确定是 SRTM1 还是 SRTM3, 并据此设置纬度/经度点数和数据间隔。然后, 它解析文件名字符串以提取西南角的经纬度, 并设置地理范围。这是文件验证的关键步骤。 |
| `bool readSrtmData(std::istream& in)` | **数据读取方法**。在 `determineSrtmInfo` 成功后被调用。它首先分配内存来创建二维高程数组 `columns`, 然后循环读取文件流, 将每个高程点的数据读入数组。它还负责处理数据在文件中和在内存中纬度方向的颠倒问题 (`columns[lon][nptlat-lat-1]`)。 |
| `short readValue(...)`                | **字节解释方法**。一个静态辅助函数, 但在 .cpp 文件中似乎被注释掉了，实际实现位于 `SrtmHgtFile::readSrtmData` 内部（注：根据 `.cpp` 文件的实际内容，`readValue` 函数是存在的，并且被 `readSrtmData` 调用）。它的作用是读取两个字节 (`unsigned char`) 并将它们从 SRTM 使用的“大端”字节序的 16 位有符号整数格式转换为主机使用的 `short` 类型。 |
| `SrtmHgtFile()` (构造函数)            | 初始化对象, 并将 `voidValue` (无效数据值) 设置为 SRTM 标准的 -32768。 |



#### 1. 头文件（SrtmHgtFile.hpp）
```cpp
class SrtmHgtFile : public DataFile
```
- 继承自DataFile基类
- 声明了三个核心私有方法
- 提供SRTM数据加载功能

#### 2. 核心方法分析

##### `loadData()` - 主加载函数
- **功能**：协调整个数据加载过程
- **流程**：
  1. 构建完整文件路径
  2. 打开二进制文件流
  3. 获取文件大小
  4. 解析文件信息
  5. 读取高程数据
  6. 关闭文件

##### `determineSrtmInfo()` - 文件信息解析
- **功能**：根据文件名和大小确定SRTM数据类型
- **解析内容**：
  - 根据文件大小判断SRTM1/SRTM3类型
  - 从文件名提取地理坐标
  - 设置数据间隔和网格大小
  - 验证文件名格式

##### `readSrtmData()` - 数据读取
- **功能**：读取实际的高程数据
- **处理过程**：
  - 分配二维数组内存
  - 按行读取高程值
  - 处理字节序转换
  - 计算最小/最大高程值

##### `readValue()` - 数值解析
- **功能**：解析16位有符号整数高程值
- **处理逻辑**：
  - 处理大端序字节序
  - 解析符号位
  - 组合高低字节



### 程序逻辑

#### 1. 初始化阶段
```
构造函数 → 设置空值标识(-32768) → 调用基类构造函数
```

#### 2. 数据加载流程
```
loadData() 调用
    ↓
构建文件路径
    ↓
打开二进制文件流
    ↓
获取文件大小
    ↓
determineSrtmInfo() - 解析文件信息
    ↓
readSrtmData() - 读取高程数据
    ↓
关闭文件，返回结果
```

#### 3. 文件信息解析逻辑
```
检查文件大小 → 确定SRTM类型(1或3弧秒)
    ↓
验证文件扩展名(.hgt/.HGT)
    ↓
解析文件名 → 提取纬度/经度坐标
    ↓
设置数据网格参数
```

#### 4. 数据读取逻辑
```
分配内存（二维数组）
    ↓
按行循环读取
    ↓
    按列循环读取 → readValue()解析字节
        ↓
    存储到数组中，倒序排列（南→北）
        ↓
    更新最小/最大高程值
```

#### 完整逻辑流程如下:

1. **创建对象**: 应用程序创建一个 `SrtmHgtFile` 类的实例。
2. **设置路径**: 调用 `setPathname()` 和 `setFilename()` 来指定要加载的 `.hgt` 文件。
3. **调用加载**: 外部代码调用 `loadData()` 方法启动加载过程。
4. **打开文件**: `loadData()` 组合路径和文件名, 并以二进制模式打开文件。如果失败, 则报错返回。
5. **获取文件信息**: 程序获取文件的总大小 (以字节为单位), 并截取文件名的最后 11 个字符 (如 `N40W118.hgt`)。
6. **解析与验证**: 将文件名和文件大小传递给 `determineSrtmInfo()` 方法。
   - 该方法首先检查文件大小是否为 `2884802` (SRTM3) 或 `25934402` (SRTM1)。如果都不是, 则认为文件无效, 返回 `false`。
   - 如果大小有效, 它会解析文件名, 提取出纬度、经度以及所在的半球 (N/S, E/W)。
   - 根据文件类型 (SRTM1/3), 它设置好数据点数量 (`nptlat`/`nptlong`) 和点间距 (`latSpacing`/`lonSpacing`) 等元数据。
7. **读取数据**: 如果 `determineSrtmInfo()` 成功返回 `true`, `loadData()` 会继续调用 `readSrtmData()`。
8. **内存分配**: `readSrtmData()` 根据刚刚确定的点数 (`nptlat`, `nptlong`) 分配一个足够大的二维数组 (`columns`) 来存储高程。
9. **循环读取**: 程序进入一个嵌套循环, 从文件流中逐点读取高程数据。
   - 每次读取两个字节。
   - 这两个字节被传递给 `readValue()`（在 `.cpp` 文件末尾实现），该函数将大端字节序的数据转换为一个 `short` 类型的整数。
   - 这个 `short` 值就是以米为单位的海拔高度。
   - 该值被存入二维数组 `columns` 中。注意, 代码中使用了 `columns[lon][nptlat-lat-1] = height;` 的方式存储, 这巧妙地解决了 SRTM 文件从北到南存储数据而数组索引通常从南到北开始的问题。
10. **加载完成**: 所有数据点都被读入内存后, `loadData()` 关闭文件并返回 `true`。此时, `SrtmHgtFile` 对象已准备就绪, 可以通过其内部的 `columns` 数组提供高程数据查询。